{{ range $attributes := .Values.nodes }}
{{ if $attributes.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "relay-node-{{ $attributes.name }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "relay-node-{{ $attributes.name }}"
  template:
    metadata:
      labels:
        app: "relay-node-{{ $attributes.name }}"
    spec:
      containers:
        - name: cardano-node
          image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag }}"
          command: [ "cardano-node" ]
          args:
            - "run"
            - "--topology"
            - "/etc/config/{{ $.Values.network }}-topology.json"
            - "--database-path"
            - "/db"
            - "--socket-path"
            - "/db/node.socket"
            - "--host-addr"
            - {{ $.Values.publicIp | quote }}
            - "--port"
            - {{ $attributes.port | quote }}
            - "--config"
            - "/etc/config/{{ $.Values.network }}-config.json"
          ports:
            - containerPort: {{ $attributes.port }}
          volumeMounts:
            - name: config-files
              mountPath: /etc/config
      volumes:
        - name: config-files
          configMap:
            name: node-configuration
{{ end }}
{{ end }}